#!/bin/bash

# Setting the color channels in ~/mlrpt/default.cfg
# Might not work yet.
wget http://happysat.nl/Meteor/html/Meteor_Status.html
apid64=`sed '180q;d' Meteor_Status.html`
apid65=`sed '181q;d' Meteor_Status.html`
apid66=`sed '182q;d' Meteor_Status.html`
apid67=`sed '190q;d' Meteor_Status.html`
apid68=`sed '191q;d' Meteor_Status.html`
apid69=`sed '192q;d' Meteor_Status.html`

if [[ $apid64 == *"On"* ]]; then
  sed 's/"# Red APID (mlrpt Channel 0)\n6[4-9]"/"# Red APID (mlrpt Channel 0)\n64"/g' ~/mlrpt/default.cfg
fi

if [[ $apid65 == *"On"* ]]; then
  sed 's/"# Green APID (mlrpt Channel 1)\n6[4-9]"/"# Green APID (mlrpt Channel 1)\n65"/g' ~/mlrpt/default.cfg
fi

if [[ $apid66 == *"On"* ]]; then
  sed 's/"# Blue APID (mlrpt Channel 2)\n6[4-9]"/"# Blue APID (mlrpt Channel 2\n66"/g' ~/mlrpt/default.cfg
fi

if [[ $apid67 == *"On"* ]]; then
  sed 's/"# Red APID (mlrpt Channel 0)\n6[4-9]"/"# Red APID (mlrpt Channel 0)\n67"/g' ~/mlrpt/default.cfg
fi

if [[ $apid68 == *"On"* ]]; then
  sed 's/"# Green APID (mlrpt Channel 1)\n6[4-9]"/"# Green APID (mlrpt Channel 1)\n68"/g' ~/mlrpt/default.cfg
fi

if [[ $apid69 == *"On"* ]]; then
  sed 's/"# Blue APID (mlrpt Channel 2)\n6[4-9]"/"# Blue APID (mlrpt Channel 2)\n69"/g' ~/mlrpt/default.cfg
fi



# Get time of the upcoming pass from predict
passtime=`predict '-p' METEOR-M2 | grep -o -m1 [0-2][0-9]:[0-5][0-9]:[0-5][0-9]`

passhour=`cut -c 1-2 <<< $passtime`
passmin=`cut -c 4-5 <<< $passtime`
passsec=`cut -c 7-8 <<< $passtime`

if [ $passhour -lt 10 ]; then
passhour=`echo $passhour | cut -c 2-2`
fi
# Convert from UTC to local time
tzoffset=`date +%z | cut -c 1-3`
passhour=$(($passhour + $tzoffset))

# If the pass starts later than half of a minute,
# it will be scheduled one minute later for optimal
# reception time.
if [ $passsec -ge 30 ]; then
passmin=$(expr $passmin + 1)
fi

if [ $passmin -lt 10 ] && [ $passsec -ge 30 ]; then
passmin=0$passmin
fi

if [ $passmin -eq 60 ]; then
passhour=$(expr $passhour + 1)
passmin="00"
fi

if [ $passhour -ge 24 ]; then
passhour=$(expr $passhour % 24)
fi

# Testing if the pass has already been scheduled
# Scheduling the upcoming pass using at if no schedule exists yet
times=`atq | grep -o [0-2][0-9]:[0-5][0-9]`
if [[ $times != *$passhour:$passmin* ]]; then
  at -Mf ~/AutoLRPT/start-mlrpt $passhour:$passmin
fi
